import pandas as pd
import os
from pathlib import Path

def create_combined_seating_chart_html(df):
    """Î™®Îì† ÌÅ¥ÎûòÏä§Ïùò ÏûêÎ¶¨ÌëúÎ•º ÌïòÎÇòÏùò HTML ÌååÏùºÎ°ú ÌÜµÌï©"""
    
    # ÌÅ¥ÎûòÏä§ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
    classes = sorted(df['ÌÅ¥ÎûòÏä§'].unique())
    
    # HTML ÏãúÏûë Î∂ÄÎ∂Ñ
    html_content = """
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï†ÑÏ≤¥ ÌÅ¥ÎûòÏä§ ÏûêÎ¶¨Ìëú</title>
    <style>
        body {
            font-family: 'Malgun Gothic', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 0;
            background: white;
            padding: 15px 20px 10px 20px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 1.8em;
        }
        
        /* ÌÉ≠ Ïä§ÌÉÄÏùº */
        .tab-container {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #ecf0f1;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #d5dbdb;
        }
        
        .tab-button.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .seating-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .seating-table {
            border-collapse: separate;
            border-spacing: 10px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .seat {
            width: 120px;
            height: 110px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            vertical-align: top;
            padding: 5px 5px 2px 5px;
            background: white;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }
        
        .seat:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .seat.excellent {
            border-color: #27ae60;
            background: linear-gradient(135deg, #ffffff 0%, #f8fff8 100%);
        }
        
        .seat.good {
            border-color: #f39c12;
            background: linear-gradient(135deg, #ffffff 0%, #fffdf8 100%);
        }
        
        .seat.needs {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #ffffff 0%, #fff8f8 100%);
        }
        
        .seat.none {
            border-color: #95a5a6;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .student-photo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            margin: 2px auto 5px;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            display: block;
        }
        
        .no-photo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: #ecf0f1;
            margin: 2px auto 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #bdc3c7;
        }
        
        .student-id {
            font-size: 0.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 3px;
            line-height: 1.1;
        }
        
        .student-score {
            font-size: 0.75em;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .excellent .student-score {
            background: #27ae60;
            color: white;
        }
        
        .good .student-score {
            background: #f39c12;
            color: white;
        }
        
        .needs .student-score {
            background: #e74c3c;
            color: white;
        }
        
        .none .student-score {
            background: #95a5a6;
            color: white;
        }
        
        /* Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ Ïä§ÌÉÄÏùº */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 90%;
        }
        
        .modal-image {
            max-width: 300px;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .modal-info {
            margin-top: 15px;
            font-size: 1.2em;
            color: #2c3e50;
        }
        
        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù Ïä§ÌÉÄÏùº */
        .password-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .password-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        
        .password-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            box-sizing: border-box;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .password-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .password-button:hover {
            background: #2980b9;
        }
        
        .password-error {
            color: #e74c3c;
            margin-top: 10px;
            display: none;
        }
        
        .main-content {
            display: none;
        }
        
        @media print {
            body { margin: 0; }
            .password-overlay { display: none !important; }
            .main-content { display: block !important; }
            .tab-container { 
                box-shadow: none;
                margin-bottom: 0;
            }
            .tab-buttons { display: none; }
            .tab-content { 
                display: none !important;
                padding: 0;
            }
            .tab-content.active { 
                display: block !important;
            }
            .seating-table { 
                page-break-inside: avoid;
                box-shadow: none;
            }
            .modal { display: none !important; }
            .header {
                box-shadow: none;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="password-overlay">
        <div class="password-container">
            <h2>ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù</h2>
            <input type="password" class="password-input" id="password-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
            <button class="password-button" id="password-button">Ïù∏Ï¶ù</button>
            <div class="password-error" id="password-error"></div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1>üè´ Ï†ÑÏ≤¥ ÌÅ¥ÎûòÏä§ ÏûêÎ¶¨Ìëú</h1>
        </div>
        
        <div class="tab-container">
            <div class="tab-buttons">
"""
    
    # ÌÉ≠ Î≤ÑÌäº ÏÉùÏÑ±
    for i, class_num in enumerate(classes):
        active_class = "active" if i == 0 else ""
        html_content += f'            <button class="tab-button {active_class}" onclick="showTab({class_num})">{class_num}Î∞ò</button>\n'
    
    html_content += """        </div>
"""
    
    # Í∞Å ÌÅ¥ÎûòÏä§Î≥Ñ ÌÉ≠ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
    for i, class_num in enumerate(classes):
        active_class = "active" if i == 0 else ""
        html_content += f"""
        <div id="class-{class_num}" class="tab-content {active_class}">
            <div class="seating-container">
                <table class="seating-table">
"""
        
        # Ìï¥Îãπ ÌÅ¥ÎûòÏä§ ÌïôÏÉùÎì§Îßå ÌïÑÌÑ∞ÎßÅ
        class_students = df[df['ÌÅ¥ÎûòÏä§'] == class_num].copy()
        
        # ÏûêÎ¶¨Ìëú ÌÅ¨Í∏∞ Í≤∞Ï†ï
        max_row = class_students['Ìñâ'].max()
        max_col = class_students['Ïó¥'].max()
        
        # ÏûêÎ¶¨Ìëú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
        seating_grid = {}
        for _, student in class_students.iterrows():
            row, col = student['Ìñâ'], student['Ïó¥']
            
            # ÏÑ±Ï†ÅÏóê Îî∞Î•∏ ÏÉâÏÉÅ ÌÅ¥ÎûòÏä§
            if pd.notna(student['Ï†êÏàò']):
                score = student['Ï†êÏàò']
                if score >= 80:
                    score_class = "excellent"
                    score_emoji = "üåü"
                elif score >= 60:
                    score_class = "good"
                    score_emoji = "üëç"
                else:
                    score_class = "needs"
                    score_emoji = "üí™"
                score_text = f"{score:.0f}"
            else:
                score_class = "none"
                score_emoji = "‚ùì"
                score_text = "-"
            
            # Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú ÌôïÏù∏
            image_path = ""
            if pd.notna(student['ÌååÏùºÎ™Ö']):
                # ÏÉÅÎåÄ Í≤ΩÎ°úÎ°ú Ïù¥ÎØ∏ÏßÄ Ï∞æÍ∏∞
                possible_paths = [
                    f"image/class_{class_num}/{student['ÌååÏùºÎ™Ö']}",
                    f"student_images/{student['ÌååÏùºÎ™Ö']}",
                    f"image/{student['ÌååÏùºÎ™Ö']}"
                ]
                
                for path in possible_paths:
                    if os.path.exists(path):
                        image_path = path
                        break
            
            # ÌïôÎ≤àÏóêÏÑú Î∞ò Î≤àÌò∏ Ï∂îÏ∂ú (3XXYY ÌòïÌÉúÏóêÏÑú XX Î∂ÄÎ∂Ñ)
            student_id = str(student['ÌïôÎ≤à'])
            if len(student_id) >= 4 and student_id.startswith('3'):
                class_number = str(int(student_id[1:3]))  # intÎ°ú Î≥ÄÌôòÌïòÏó¨ ÏïûÏùò 0 Ï†úÍ±∞
            else:
                class_number = str(class_num)
            
            seating_grid[(row, col)] = {
                'id': f"{class_number}Î∞ò {student['Ïù¥Î¶Ñ']}",
                'name': student['Ïù¥Î¶Ñ'],
                'score_text': score_text,
                'score_class': score_class,
                'score_emoji': score_emoji,
                'image_path': image_path,
                'has_photo': pd.notna(student['ÌååÏùºÎ™Ö'])
            }
        
        # ÏûêÎ¶¨Ìëú ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        for row in range(1, max_row + 1):
            # Ìï¥Îãπ ÌñâÏóê ÌïôÏÉùÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
            has_students_in_row = any((row, col) in seating_grid for col in range(1, max_col + 1))
            
            # ÌïôÏÉùÏù¥ ÏûàÎäî ÌñâÎßå Ï∂úÎ†•
            if has_students_in_row:
                html_content += "                    <tr>\n"
                
                for col in range(1, max_col + 1):
                    if (row, col) in seating_grid:
                        student = seating_grid[(row, col)]
                        
                        # Ïù¥ÎØ∏ÏßÄ HTML
                        if student['image_path'] and os.path.exists(student['image_path']):
                            image_html = f'<img src="{student["image_path"]}" alt="{student["name"]}" class="student-photo">'
                        else:
                            image_html = '<div class="no-photo">üë§</div>'
                        
                        html_content += f"""                        <td class="seat {student['score_class']}">
                            {image_html}
                            <div class="student-id">{student['id']}</div>
                            <div class="student-score">{student['score_emoji']} {student['score_text']}</div>
                        </td>
"""
                    else:
                        html_content += '                        <td class="seat"></td>\n'
                
                html_content += "                    </tr>\n"
        
        html_content += """                </table>
            </div>
        </div>
"""
    
    html_content += """    </div>
    </div>
    
    <!-- Ïù¥ÎØ∏ÏßÄ Î™®Îã¨ -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <img id="modalImage" class="modal-image" src="" alt="">
            <div id="modalInfo" class="modal-info"></div>
        </div>
    </div>
    
    <script>
        // ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function showTab(classNum) {
            // Î™®Îì† ÌÉ≠ Î≤ÑÌäºÍ≥º ÏΩòÌÖêÏ∏† ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(`class-${classNum}`).classList.add('active');
        }
        
        // Î™®Îã¨ Í¥ÄÎ†® ÏöîÏÜåÎì§
        const modal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalInfo = document.getElementById('modalInfo');
        const closeBtn = document.querySelector('.close');
        
        // ÏûêÎ¶¨ ÌÅ¥Î¶≠ Ïãú ÌïôÏÉù Ï†ïÎ≥¥ Í∞ïÏ°∞ Î∞è Ïù¥ÎØ∏ÏßÄ Î™®Îã¨
        document.querySelectorAll('.seat:not(:empty)').forEach(seat => {
            seat.addEventListener('click', function() {
                // Í∏∞Ï°¥ Í∞ïÏ°∞ Ï†úÍ±∞
                document.querySelectorAll('.seat').forEach(s => s.style.transform = '');
                
                // ÌÅ¥Î¶≠Îêú ÏûêÎ¶¨ Í∞ïÏ°∞
                this.style.transform = 'scale(1.05)';
                
                // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ Î™®Îã¨ ÌëúÏãú
                const img = this.querySelector('.student-photo');
                if (img) {
                    modalImage.src = img.src;
                    modalImage.alt = img.alt;
                    
                    const studentId = this.querySelector('.student-id').textContent;
                    const studentScore = this.querySelector('.student-score').textContent;
                    modalInfo.innerHTML = `<strong>${studentId}</strong><br>ÏÑ±Ï†Å: ${studentScore}`;
                    
                    modal.style.display = 'block';
                }
                
                // 3Ï¥à ÌõÑ Í∞ïÏ°∞ Ìï¥Ï†ú
                setTimeout(() => {
                    this.style.transform = '';
                }, 3000);
            });
        });
        
        // Î™®Îã¨ Îã´Í∏∞
        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        
        // Î™®Îã¨ Î∞∞Í≤Ω ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                modal.style.display = 'none';
            }
        });
        
        // Ïù∏ÏáÑ Í∏∞Îä•
        function printSeatingChart() {
            window.print();
        }
        
        // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ (Ctrl+P)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printSeatingChart();
            }
        });
        
        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù
        const passwordInput = document.getElementById('password-input');
        const passwordButton = document.getElementById('password-button');
        const passwordError = document.getElementById('password-error');
        const mainContent = document.querySelector('.main-content');
        const passwordOverlay = document.querySelector('.password-overlay');
        
        passwordButton.addEventListener('click', function() {
            const password = passwordInput.value.trim();
            if (password === '1679') {
                mainContent.style.display = 'block';
                passwordOverlay.style.display = 'none';
            } else {
                passwordError.style.display = 'block';
                passwordError.textContent = 'ÏûòÎ™ªÎêú ÎπÑÎ∞ÄÎ≤àÌò∏ÏûÖÎãàÎã§.';
                passwordInput.value = '';
                passwordInput.focus();
            }
        });
        
        // Enter ÌÇ§Î°ú ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù
        passwordInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                passwordButton.click();
            }
        });
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•Ï∞ΩÏóê Ìè¨Ïª§Ïä§
        passwordInput.focus();
    </script>
</body>
</html>
"""
    
    # HTML ÌååÏùº Ï†ÄÏû•
    filename = 'all_classes_seating_chart.html'
    with open(filename, 'w', encoding='utf-8') as f:
        f.write(html_content)
    
    file_size = os.path.getsize(filename) / 1024  # KB Îã®ÏúÑ
    print(f"‚úÖ {filename} ÏÉùÏÑ± ÏôÑÎ£å ({file_size:.1f} KB)")
    
    return filename

def main():
    """Î©îÏù∏ Ìï®Ïàò"""
    print("=" * 60)
    print("              ÌÜµÌï© ÏûêÎ¶¨Ìëú HTML ÏÉùÏÑ±Í∏∞")
    print("=" * 60)
    
    # Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    try:
        df = pd.read_csv('integrated_student_data.csv', encoding='utf-8-sig')
        print(f"‚úÖ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å: {len(df)}Î™ÖÏùò ÌïôÏÉù Ï†ïÎ≥¥")
        
        classes = sorted(df['ÌÅ¥ÎûòÏä§'].unique())
        print(f"üìö Î∞úÍ≤¨Îêú ÌÅ¥ÎûòÏä§: {classes}")
        
        # ÌÜµÌï© HTML ÏÉùÏÑ±
        print("\nüåê ÌÜµÌï© ÏûêÎ¶¨Ìëú HTML ÏÉùÏÑ± Ï§ë...")
        filename = create_combined_seating_chart_html(df)
        
        print("\n" + "=" * 60)
        print("                HTML ÏÉùÏÑ± ÏôÑÎ£å!")
        print("=" * 60)
        print(f"üåê ÏÉùÏÑ±Îêú ÌååÏùº: {filename}")
        print("\nüí° ÏÇ¨Ïö©Î≤ï:")
        print("  ‚Ä¢ HTML ÌååÏùºÏùÑ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Ïó¥Ïñ¥ ÏûêÎ¶¨ÌëúÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî")
        print("  ‚Ä¢ ÏÉÅÎã® ÌÉ≠ÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÌÅ¥ÎûòÏä§Î•º Ï†ÑÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§")
        print("  ‚Ä¢ ÌïôÏÉù ÏÇ¨ÏßÑÏùÑ ÌÅ¥Î¶≠ÌïòÎ©¥ ÌÅ∞ Ïù¥ÎØ∏ÏßÄÎ•º Î≥º Ïàò ÏûàÏäµÎãàÎã§")
        print("  ‚Ä¢ Ctrl+PÎ°ú Ïù∏ÏáÑÌï† Ïàò ÏûàÏäµÎãàÎã§")
        print("  ‚Ä¢ ÏÑ±Ï†ÅÏóê Îî∞Îùº ÏÉâÏÉÅÏù¥ Íµ¨Î∂ÑÎêòÏñ¥ ÏûàÏäµÎãàÎã§")
        
    except FileNotFoundError:
        print("‚ùå integrated_student_data.csv ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.")
        print("   Î®ºÏ†Ä Îç∞Ïù¥ÌÑ∞ ÌÜµÌï©ÏùÑ Ïã§ÌñâÌï¥Ï£ºÏÑ∏Ïöî.")
    except Exception as e:
        print(f"‚ùå Ïò§Î•ò Î∞úÏÉù: {e}")

if __name__ == "__main__":
    main()
